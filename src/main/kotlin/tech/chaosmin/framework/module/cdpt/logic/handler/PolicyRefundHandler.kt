/**
 * Copyright (c) 2020-2021 Romani Min
 * All rights reserved.
 *
 * If you are not the intended user, you are hereby notified that any use, disclosure, copying, printing, forwarding or
 * dissemination of this property is strictly prohibited. If you have got this file in error, delete it from your system.
 */
package tech.chaosmin.framework.module.cdpt.logic.handler

import cn.hutool.core.date.DateUtil
import org.slf4j.LoggerFactory
import org.springframework.amqp.rabbit.core.RabbitTemplate
import org.springframework.beans.factory.annotation.Value
import org.springframework.stereotype.Component
import tech.chaosmin.framework.base.RestResult
import tech.chaosmin.framework.base.RestResultExt
import tech.chaosmin.framework.base.enums.ErrorCodeEnum
import tech.chaosmin.framework.base.enums.PolicyProcessEnum
import tech.chaosmin.framework.exception.FrameworkException
import tech.chaosmin.framework.module.cdpt.api.convert.ChannelRequestConvert
import tech.chaosmin.framework.module.cdpt.entity.PolicyEntity
import tech.chaosmin.framework.module.cdpt.entity.channel.dadi.response.DDResp
import tech.chaosmin.framework.module.cdpt.entity.channel.dadi.response.obj.DDCPResp
import tech.chaosmin.framework.module.cdpt.entity.enums.PayStatusEnum
import tech.chaosmin.framework.module.cdpt.entity.enums.PayTypeEnum
import tech.chaosmin.framework.module.cdpt.entity.enums.PolicyStatusEnum
import tech.chaosmin.framework.module.cdpt.logic.interrogator.PolicyInterrogator
import tech.chaosmin.framework.module.cdpt.logic.outer.partner.DadiInsurerService
import tech.chaosmin.framework.utils.JsonUtil
import java.util.*

/**
 * @author Romani min
 * @since 2021/6/24 21:46
 */
@Component
open class PolicyRefundHandler(
    private val policyInterrogator: PolicyInterrogator,
    private val dadiInsurerService: DadiInsurerService,
    private val rabbitTemplate: RabbitTemplate
) {
    private val logger = LoggerFactory.getLogger(PolicyRefundHandler::class.java)

    @Value("\${test.mock:false}")
    private val mock: Boolean = false

    fun operate(id: Long): RestResult<PolicyEntity> {
        val policy = policyInterrogator.getOne(id) ?: throw FrameworkException(ErrorCodeEnum.RESOURCE_NOT_EXIST.code, "保单[$id]")
        if (policy.status == PolicyStatusEnum.SURRENDERED) {
            throw FrameworkException(ErrorCodeEnum.NOT_SUPPORTED_PARAM_TYPE.code, "保单已退保")
        }
        if (policy.effectiveTime!! < Date()) {
            logger.error("该保单[$id]已从 ${policy.effectiveTime} 起生效, 如需退保请走线下流程")
            throw FrameworkException(ErrorCodeEnum.NOT_SUPPORTED_PARAM_TYPE.code, "保单已生效")
        }

        val ddReq = ChannelRequestConvert.convert2DDCPReq(policy)
        dadiInsurerService.request(PolicyProcessEnum.POLICY_CANCEL, ddReq) {
            val str = if (mock) {
                """{"responseHead":{"responseTime":"2021-07-12T14:21:27","resultCode":"0","resultMessage":"本次批改执行成功！","responseId":"b3a0e7a2-6616-4472-ae37-a1b1970b75df"},"responseBody":{"endorsement":{"endoNo":"EEGC21310116020000000009","endoPrintNo":"6","duePremium":-25,"isGenerateElecEndo":"Y","content":"  兹经投保人申请，本公司同意自2021年7月13日0时起，对保险单号码为PEGC21310116020000000051的\n保单作保单注销。\n    本次批改合计注销保费:人民币贰拾伍元整（CNY25）\n    本保险单保险责任终止，特此批注。"},"policyMap":{"isEProposal":"Y","policyNature":"01","beforeVatPremium":0,"judicalScopeCode":"01","handlerName":"王溃溃","policyNo":"PEGC21310116020000000051","productName":"大地行出境人员意外伤害保险","isPackageProduct":"N","comPostCode":"200080","certificatePayMentType":"","sumInsured":0,"isSmallAmount":"N","isGovernmentBiz":"N","belongToHandler2Name":"王溃溃","issueUserCode":"8000579613","argueSolutionType":"01","businessSourceCode":"0101","siCurrencyCode":"CNY","insuredName":"李四","channelOpInfoList":[{"channelComCode":"31011500","channelSeqNo":"202107121359110004","channelProductCode":"EGC","trxDate":"2021-07-12","channelCode":"E00149-002"}],"isAutoUw":"Y","sequenceNumber":1,"issueUserName":"钟思妮","agricultureRelaType":"N","orgName":"上海分公司营业部银保渠道部","totalDiscountRate":0,"groupBusinessCode":"02","sumMainPrem":0,"vat":0,"businessAttribute":"E00149","handlerCode":"8000500301","isIssueAfterPay":"N","proposalNo":"TEGC21310116020000000051","premiumBookExchangeRate":1,"salesName":"上海分公司营业部银保渠道部","proposalStatus":"275","shortRateType":"04","policyHolderName":"堡垒","underwritingDate":"2021-07-12T13:59:56","operateDate":"2021-07-12","policyPrintType":2,"belongToHandlerCode":"8000500301","proposalDate":"2021-07-12","siLocalExchangeRate":1,"sumSubPrem":0,"electronicPolicyTemplateId":"form032_1_N","duePremium":0,"secondLine":72000,"internalCoInsuranceType":"01","policyCustomerList":[{"customerType":"01","nationalityCode":"CHN","partyCategory":"02","idType":"803","customerRoleCode":"1","idNo":"1234567","customerName":"堡垒"}],"coInsuranceType":"01","isLargeGroupPolicy":"N","issueOrgCode":"31011602","policyStatus":275,"isSpecialBusiness":"N","policyLobList":[{"totalInsuredCount":1,"rescueCompanyCode":"2303285836123","policyRiskList":[{"personInsuredList":[{"sequenceNumber":1,"benefitModeCode":"1","idType":"414","duePremium":0,"dateOfBirth":"1995-02-15","antiMoneyResultCode":"0","isOnJob":"N","policyStatus":2,"idNo":"ERT098492","customerName":"李四","keyCoveragePlanGroup":"1","expiryDate":"2021-07-13T23:59:59","nationalityCode":"CHN","partyCategory":"01","polHolderInsuredRelaCode":"80","basePremiumLocal":0,"customerRoleCode":"2","numberOfCopies":1,"hasAffilInsured":"N","indiGenderCode":"1","age":26,"effectiveDate":"2021-07-13"}],"insuredGroupList":[{"insuredGroupNo":1,"basePremiumLocal":0,"duePremium":0,"policyCoverageList":[{"clauseCode":"CF2100218","sequenceNumber":13000,"shortRate":1,"kindCode":"C100552","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.0005,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"附加旅程取消保险条款","kindName":"旅程取消","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100223","kindCode":"C100503","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"premiumRate":0.00053333333,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","sumInsured":0,"isFinalLevelCt":"Y","unitPremium":0,"kindName":"住院补贴","clauseName":"中国大地保险附加通用住院补贴医疗保险条款","currency":"CNY","isMainCoverage":"N","sequenceNumber":9000,"shortRate":1,"vat":0,"subsidyAmount":50,"isNonDeductible":"N","avgSumInsured":0,"basePremiumLocal":0,"subsidyDay":30,"effectiveDate":"2021-07-13"},{"clauseCode":"CF2100194","sequenceNumber":7000,"shortRate":1,"kindCode":"C100417","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.000005,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"kindName":"突发急性病身故","clauseName":"中国大地保险附加突发急性病身故保险条款","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100216","sequenceNumber":8000,"shortRate":1,"kindCode":"C100550","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.0000625,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"中国大地保险附加境外旅行医疗保险条款","kindName":"境外旅行意外和突发急性病医疗","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100231","sequenceNumber":18000,"shortRate":1,"kindCode":"C100543","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.0001,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"附加家居保障保险条款","kindName":"家居保障","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100230","sequenceNumber":19000,"shortRate":1,"kindCode":"C100542","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.000005,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"附加个人第三者责任保险条款","kindName":"个人第三者责任","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100256","sequenceNumber":15000,"shortRate":1,"kindCode":"C100560","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.0008,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"kindName":"行李延误","clauseName":"附加行李延误保险条款（B款）","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100212","sequenceNumber":10000,"shortRate":1,"kindCode":"C100540","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.00002,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"中国大地保险附加医疗转运与送返医疗保险条款","kindName":"紧急医疗转运与送返","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100233","sequenceNumber":17000,"shortRate":1,"kindCode":"C100547","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.0009,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"附加个人行李及随身物品损失保险条款","kindName":"个人行李及随身物品损失","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF1100278","kindCode":"C100436","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"premiumRate":0.000036,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","sumInsured":0,"disabilityStandard":"3","isFinalLevelCt":"Y","unitPremium":0,"clauseName":"大地行出境意外伤害保险条款","kindName":"出境人员意外伤害","currency":"CNY","isMainCoverage":"Y","sequenceNumber":1000,"shortRate":1,"vat":0,"isNonDeductible":"N","avgSumInsured":0,"basePremiumLocal":0,"effectiveDate":"2021-07-13"},{"clauseCode":"CF2100228","sequenceNumber":11000,"shortRate":1,"kindCode":"C100562","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.000011,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"附加遗体送返保险条款","kindName":"遗体送返","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100269","kindCode":"C100620","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"premiumRate":0.000002,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","sumInsured":0,"disabilityStandard":"3","isFinalLevelCt":"Y","unitPremium":0,"clauseName":"附加自驾意外伤害保险条款","kindName":"自驾意外伤害","currency":"CNY","isMainCoverage":"N","sequenceNumber":6000,"shortRate":1,"vat":0,"isNonDeductible":"N","avgSumInsured":0,"basePremiumLocal":0,"effectiveDate":"2021-07-13"},{"clauseCode":"CF2100229","sequenceNumber":12000,"shortRate":1,"kindCode":"C100563","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.00004,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"中国大地保险附加住院探望费用补偿保险条款","kindName":"住院探望","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF2100220","sequenceNumber":14000,"shortRate":1,"kindCode":"C100554","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.00666666667,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"附加旅程延误保险条款","kindName":"旅程延误","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"},{"clauseCode":"CF1100290","kindCode":"C100590","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"premiumRate":0.000004,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","sumInsured":0,"disabilityStandard":"3","isFinalLevelCt":"Y","unitPremium":0,"clauseName":"大地通达公共交通工具意外伤害保险条款","kindName":"公共交通意外伤害-汽车","currency":"CNY","isMainCoverage":"Y","sequenceNumber":2000,"shortRate":1,"vat":0,"isNonDeductible":"N","avgSumInsured":0,"basePremiumLocal":0,"effectiveDate":"2021-07-13"},{"clauseCode":"CF1100290","kindCode":"C100469","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"premiumRate":0.0000025,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","sumInsured":0,"disabilityStandard":"3","isFinalLevelCt":"Y","unitPremium":0,"clauseName":"大地通达公共交通工具意外伤害保险条款","kindName":"公共交通意外伤害-轮船","currency":"CNY","isMainCoverage":"Y","sequenceNumber":3000,"shortRate":1,"vat":0,"isNonDeductible":"N","avgSumInsured":0,"basePremiumLocal":0,"effectiveDate":"2021-07-13"},{"clauseCode":"CF1100290","kindCode":"C100468","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"premiumRate":0.0000015,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","sumInsured":0,"disabilityStandard":"3","isFinalLevelCt":"Y","unitPremium":0,"clauseName":"大地通达公共交通工具意外伤害保险条款","kindName":"公共交通意外伤害-飞机","currency":"CNY","isMainCoverage":"Y","sequenceNumber":4000,"shortRate":1,"vat":0,"isNonDeductible":"N","avgSumInsured":0,"basePremiumLocal":0,"effectiveDate":"2021-07-13"},{"clauseCode":"CF1100290","kindCode":"C100470","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"premiumRate":0.0000015,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","sumInsured":0,"disabilityStandard":"3","isFinalLevelCt":"Y","unitPremium":0,"clauseName":"大地通达公共交通工具意外伤害保险条款","kindName":"公共交通意外伤害-火车（地铁、轻轨）","currency":"CNY","isMainCoverage":"Y","sequenceNumber":5000,"shortRate":1,"vat":0,"isNonDeductible":"N","avgSumInsured":0,"basePremiumLocal":0,"effectiveDate":"2021-07-13"},{"clauseCode":"CF2100213","sequenceNumber":16000,"shortRate":1,"kindCode":"C100541","vatRateType":"A","beforeVatPremium":0,"vatRate":0.06,"duePremium":0,"vat":0,"premiumRate":0.00035,"policyStatus":2,"expiryDate":"2021-07-13T23:59:59","isIncludedInSumInsured":"Y","isNonDeductible":"N","sumInsured":0,"avgSumInsured":0,"basePremiumLocal":0,"isFinalLevelCt":"Y","unitPremium":0,"clauseName":"附加境外旅行证件重置保险条款","kindName":"旅行证件重置","currency":"CNY","effectiveDate":"2021-07-13","isMainCoverage":"N"}],"planName":"大地行出境人员意外伤害保险-海外计划一","numberOfCopies":1,"planCode":"EGC2150028","insuredCount":1}]}],"rescueModelCode":"02","rescuePhone":"86-21-61297908","ahPaymentMethodCode":"02","basePremiumLocal":0,"policyFormList":[{"customFormNo":"A00065","sequenceNumber":1,"customFormTitle":"自编特约","formCategory":"2","customFormContent":"1、在保险期间内，被保险人旅行期间遭受意外或者突发急性病，在二级以上（含）公立医院治疗由该意外引致的伤害或者该急性病，保险人就该意外或者该急性病发生之日起九十日所支出的符合当地城镇职工基本医疗保险规定的支/给付范围和标准的（被保险人系境外旅游的，境外治疗不在此限）、医学必要的医疗费用（以下简称“每次事故合理医疗费用”），按“（每次事故合理医疗费用-人民币0元）×100%”给付意外医疗或者急性病医疗保险金。\r2、本保单投保年龄为30天-85周岁。针对其中70周岁以上的被保险人，保险人承担的“意外身故及伤残”责任限额为10万、“突发急性病身故/新冠肺炎身故”的责任限额为5万元。\r3、旅程延误：每延误5小时赔付300元，以保额为限。\r4、行李延误：每延误6小时赔付500元，以保额为限。\r5、个人行李及随身物品损失：每件或每套行李物品限额1000元。\r6、未成年人赔偿限额按保监会规定。\r7、若投保一年期保单，被保险人在保险期间内多次出行的，保险人就每次旅行最多承担出境之日起至第90天的保险责任。\r8、本方案每人限投一份，多投无效。"},{"customFormNo":"A00116","sequenceNumber":2,"customFormTitle":"伤残特约（行标）","formCategory":"2","customFormContent":"被保险人自遭受该意外之日起一百八十日内以该意外为直接、完全原因而导致《人身保险伤残评定标准及代码》（JR/T 0083—2013，保监发[2014]6号）中所列伤残的，保险人按该处残疾的伤残等级对应的给付比例和该被保险人的意外伤害保险金额的乘积给付意外伤残保险金。伤残等级对应的保险金给付比例分为十档，伤残程度第一级对应的保险金给付比例为100%，伤残程度第十级对应的保险金给付比例为10%，每级相差10%。"}]}],"expiryDate":"2021-07-13T23:59:59","regionCode":"310000","isRenewable":"Y","isSendSms":"N","orgCode":"31011504","belongToHandlerName":"王溃溃","bookCurrency":"CNY","policyPaymentInfoList":[{"sequenceNumber":1,"installmentPeriodCount":1,"installmentList":[{"sequenceNumber":1,"installmentDate":"2021-07-13","installmentAmount":25,"beforeVatPremium":23.56,"dueDate":"2021-07-13","installmentPeriodSeq":1,"vat":1.44,"payReasonCode":"R10","serialNo":1}]}],"premiumCurrencyCode":"CNY","shortRate":1,"businessSource2Code":"0101","invoiceInfoList":[{"customerType":"1","taxPayerType":"4","companyName":"堡垒","invoiceType":"2","copyDataFromType":"1"}],"renewalType":"1","idCheckResultCode":"100","localCurrencyCode":"CNY","terminateDate":"2021-07-13","isSavePlanDetail":"N","issueOrgName":"浦东支公司综合部","comAddress":"上海市虹口区吴淞路130号704室","businessCate":"1","insuredListType":"1","productCode":"EGC","cessionBasisCode":2,"policyType":"1","basePremiumLocal":0,"channelCodeByPerson":"C0000016","isSpecialGroup":"N","effectiveDate":"2021-07-13T00:00:00","belongToHandler2Code":"8000500301"}}}"""
            } else it
            val response = JsonUtil.decode(str, DDResp::class.java, DDCPResp::class.java)
            // 请求保司退保成功
            if (response?.responseBody is DDCPResp && "0" == response.responseHead?.resultCode) {
                policy.status = PolicyStatusEnum.SURRENDERED
                policy.refundTime = DateUtil.parseUTC(response.responseHead?.responseTime)
                logger.info("Send message to queue [policy], message: ${JsonUtil.encode(policy)}")
                rabbitTemplate.convertAndSend("policy", policy.update())
                if (policy.payType == PayTypeEnum.ONLINE && policy.payStatus == PayStatusEnum.PAYMENT_SUCCESSFUL) {
                    // 如果是线上支持成功的, 则进行退费操作
                    rabbitTemplate.convertAndSend("refund", policy)
                }
            } else throw FrameworkException(ErrorCodeEnum.BUSINESS_ERROR.code, response?.responseHead?.resultMessage ?: "请求第三方下单接口异常")
        }

        return RestResultExt.successRestResult(policy)
    }
}